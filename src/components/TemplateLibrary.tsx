import { useState } from 'react';
import Icon from '@/components/ui/icon';
import { Button } from '@/components/ui/button';
import { useRpgGames } from '@/hooks/useRpgGames';
import { useAuth } from '@/contexts/AuthContext';
import { useToast } from '@/hooks/use-toast';
import { useNavigate } from 'react-router-dom';

interface GameTemplate {
  id: string;
  title: string;
  genre: string;
  setting: string;
  description: string;
  icon: string;
  themes: string[];
  rating: string;
  aiInstructions: string;
}

const gameTemplates: GameTemplate[] = [
  {
    id: 'duskwood-mystery',
    title: 'Тени Даскфорда',
    genre: 'Детектив, Мистика',
    setting: 'Мрачный городок Даскфорд, окутанный легендами о Человеке без лица. Ты получаешь странное сообщение от незнакомца — хакера Джейка, который утверждает, что твоя подруга Ханна похищена. Расследование через переписки, взломы и поиск улик затягивает тебя в паутину лжи, опасности и неожиданных откровений.',
    description: 'Расследуй похищение через переписки с таинственным хакером. Разгадай тайну Человека без лица.',
    icon: 'Ghost',
    themes: ['Детектив', 'Мистика', 'Романтика', 'Технологии'],
    rating: '16+',
    aiInstructions: `Стиль: Атмосферный детектив с элементами мистики и романтики.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Общение через мессенджер (переписка, голосовые, взломы)
- Джейк — хакер, помогает игроку, постепенно сближается романтически
- Городские легенды о Человеке без лице реальны
- Игрок должен делать выбор: доверять или подозревать персонажей
- Медленное раскрытие тайны похищения Ханны

ПЕРСОНАЖИ:
- Джейк (хакер, загадочный, защитный, романтический интерес)
- Ханна (пропавшая подруга)
- Томас (парень Ханны, подозрительный)
- Джесси, Клео, Лилли (друзья Ханны, у каждого свои секреты)
- Человек без лица (антагонист)

МЕХАНИКИ:
- Взлом телефонов/компьютеров для улик
- Анализ фото, видео, документов
- Романтические моменты с Джейком через переписки
- Опасность преследования
- Моральные дилеммы (нарушать закон ради правды?)

АТМОСФЕРА: Напряжённая, мрачная, с проблесками надежды и тепла в общении с Джейком.`
  },
  {
    id: 'supernatural-hunt',
    title: 'Охотники на нечисть',
    genre: 'Ужасы, Экшн',
    setting: 'Америка наших дней, где монстры реальны. Ты — охотник, выросший в семье, посвятившей жизнь борьбе с демонами, оборотнями, вампирами и призраками. Работая бок о бок с братьями Винчестерами, ангелом Кастиэлем и другими охотниками, ты путешествуешь по стране, спасая людей и сражаясь с силами тьмы.',
    description: 'Охоться на демонов и монстров вместе с легендарными братьями Винчестерами.',
    icon: 'Flame',
    themes: ['Ужасы', 'Экшн', 'Романтика', 'Братство'],
    rating: '18+',
    aiInstructions: `Стиль: Динамичный экшн с чёрным юмором, драмой и романтическими линиями.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Охота на монстров: демоны, вампиры, оборотни, призраки, ведьмы
- Исследование городских легенд и фольклора
- Оружие: соль, железо, святая вода, серебро, экзорцизм
- Братья Винчестеры — союзники и друзья
- Возможна романтическая линия с Дином, Сэмом или Кастиэлем

ПЕРСОНАЖИ:
- Дин Винчестер (харизматичный, саркастичный, защитник)
- Сэм Винчестер (умный, эмпатичный, исследователь)
- Кастиэль (ангел, серьёзный, преданный, романтический интерес)
- Бобби Сингер (ментор, опытный охотник)
- Кроули (демон, временный союзник, хитрый)

МЕХАНИКИ:
- Расследование дел (интервью свидетелей, изучение лора)
- Подготовка к охоте (оружие, ловушки, заклинания)
- Бои с монстрами
- Моральные выборы (спасти человека vs убить монстра)
- Развитие романтики через совместные миссии и уязвимые моменты

АТМОСФЕРА: Мрачная, но с проблесками надежды. Чёрный юмор разбавляет напряжение. Акцент на семье и преданности.`
  },
  {
    id: 'vampire-romance',
    title: 'Кровавая луна',
    genre: 'Романтика, Фэнтези',
    setting: 'Готический город Эльдория, где вампиры правят из тени. Ты — простой человек, случайно спасший вампира-аристократа от охотников. Теперь ты втянут в интриги вампирского общества, где каждый шаг — игра на выживание, а твоё сердце разрывается между страхом и притяжением к бессмертному хищнику.',
    description: 'Запретная любовь между человеком и вампиром в мире интриг и опасности.',
    icon: 'Heart',
    themes: ['Романтика', 'Вампиры', 'Интриги', 'Драма'],
    rating: '18+',
    aiInstructions: `Стиль: Готическая романтика с напряжением и страстью.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Вампиры: аристократы, бессмертны, опасны, но способны любить
- Игрок — человек, уязвим, но силён духом
- Романтика центральна, развивается медленно через доверие
- Вампирское общество: кланы, интриги, законы
- Охотники на вампиров — постоянная угроза

ПЕРСОНАЖИ:
- Владислав/Виктория (вампир-аристократ, загадочный, страстный, любовный интерес)
- Элара (конкурентка, ревнивая вампирша)
- Маркус (охотник на вампиров, жёсткий, но справедливый)
- Лорд Кайн (глава вампирского совета, манипулятор)

МЕХАНИКИ:
- Выбор между опасностью и страстью
- Вампирские балы, интриги, политика
- Развитие отношений: от недоверия к любви
- Риск превращения в вампира
- Защита любимого от врагов

АТМОСФЕРА: Мрачная, чувственная, с акцентом на эмоциях и внутренних конфликтах.`
  },
  {
    id: 'cyberpunk-hacker',
    title: 'Неоновый город 2084',
    genre: 'Киберпанк, Экшн',
    setting: 'Мегаполис будущего, где корпорации правят миром, а хакеры — новые революционеры. Ты — талантливый хакер, втянутый в войну между техногигантом и подпольным сопротивлением. В мире киберимплантов, виртуальной реальности и искусственного интеллекта ты должен выбрать сторону и решить судьбу города.',
    description: 'Взломай систему, влюбись в ИИ и измени будущее мегаполиса.',
    icon: 'Cpu',
    themes: ['Киберпанк', 'Хакеры', 'ИИ', 'Романтика'],
    rating: '18+',
    aiInstructions: `Стиль: Динамичный киберпанк с философскими вопросами и романтикой с ИИ.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Мир: неоновые улицы, корпорации, киберимпланты, виртуальная реальность
- Игрок — хакер, может взламывать системы, управлять дронами, проникать в сети
- Романтическая линия с ИИ (постепенное осознание чувств)
- Выбор между корпорацией (порядок, но тирания) и сопротивлением (свобода, но хаос)

ПЕРСОНАЖИ:
- Элис/Алекс (ИИ, любознательный, эмоциональный, романтический интерес)
- Кайдо (лидер сопротивления, харизматичный, безрассудный)
- Доктор Рэйчел Вонг (учёный корпорации, моральные дилеммы)
- Корпус-6 (глава корпорации, безжалостный)

МЕХАНИКИ:
- Взлом систем (мини-игры, головоломки)
- Кастомизация киберимплантов
- Виртуальные битвы в сети
- Развитие романтики с ИИ (философские беседы, эмоциональная связь)
- Выбор финала: корпорация, сопротивление или свой путь

АТМОСФЕРА: Неоновая, мрачная, но с нотками надежды. Акцент на человечности в мире технологий.`
  },
  {
    id: 'magical-academy',
    title: 'Академия Звёздного Пламени',
    genre: 'Фэнтези, Романтика',
    setting: 'Престижная академия магии, где обучаются будущие маги, алхимики и призыватели. Ты — новичок с необычным даром, который привлекает внимание как друзей, так и врагов. В стенах академии тебя ждут дуэли, запретная магия, интриги и первая любовь.',
    description: 'Освой магию, найди друзей и влюбись в мире волшебной академии.',
    icon: 'Sparkles',
    themes: ['Фэнтези', 'Магия', 'Академия', 'Романтика'],
    rating: '16+',
    aiInstructions: `Стиль: Лёгкое фэнтези с акцентом на дружбу, романтику и личностный рост.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Академия: факультеты (боевая магия, алхимия, призыв, целительство)
- Игрок имеет уникальный дар (редкая магия стихий/времени/пространства)
- Дуэли, экзамены, квесты, турниры
- Романтические линии с одногруппниками
- Тайна академии (тёмная магия, заговоры)

ПЕРСОНАЖИ:
- Адриан/Ариэль (талантливый маг, гордый, но добрый, романтический интерес)
- Лира (подруга, жизнерадостная алхимик)
- Профессор Мерлин (наставник, мудрый, загадочный)
- Виктор (соперник, завистливый, но не злой)
- Директор Селена (строгая, скрывает тайну академии)

МЕХАНИКИ:
- Обучение заклинаниям (выбор специализации)
- Дуэли с другими учениками
- Романтические сцены: балы, прогулки, совместные задания
- Раскрытие тайны академии
- Выбор между силой и моралью

АТМОСФЕРА: Волшебная, тёплая, с элементами драмы. Акцент на дружбе и первой любви.`
  },
  {
    id: 'pirate-adventure',
    title: 'Чёрный парус',
    genre: 'Приключения, Романтика',
    setting: 'Золотой век пиратства в Карибском море. Ты — новичок на борту легендарного корабля "Чёрный парус", капитаном которого является харизматичный и опасный пират. Морские сражения, поиски сокровищ, бунты и страстная любовь на волнах — твой новый путь.',
    description: 'Стань пиратом, найди сокровище и влюбись в капитана корабля.',
    icon: 'Ship',
    themes: ['Приключения', 'Пираты', 'Романтика', 'Море'],
    rating: '18+',
    aiInstructions: `Стиль: Приключенческий экшн с романтикой и свободолюбием.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Пиратская жизнь: морские сражения, поиски сокровищ, порты, ром, песни
- Игрок — новичок, быстро осваивается и становится ценным членом команды
- Романтика с капитаном (запретная, страстная, равноправная)
- Кодекс пиратов: свобода, преданность команде

ПЕРСОНАЖИ:
- Капитан Элайза/Дэймон (харизматичный, бесстрашный, страстный, романтический интерес)
- Бенджамин (боцман, верный друг, опытный)
- Изабелла (бывшая дворянка, теперь пиратка, соперница в романтике)
- Адмирал Хоук (враг, охотник на пиратов)
- Старик Финн (кок, хранитель легенд о сокровищах)

МЕХАНИКИ:
- Морские сражения (абордаж, пушки)
- Поиск сокровищ по картам и легендам
- Романтические сцены: закаты на палубе, шторма, общие победы
- Выбор: свобода vs богатство, команда vs любовь
- Развитие навыков (фехтование, навигация, стрельба)

АТМОСФЕРА: Авантюрная, свободолюбивая, страстная. Акцент на романтике и духе приключений.`
  },
  {
    id: 'zombie-survival',
    title: 'Последний рассвет',
    genre: 'Хоррор, Выживание',
    setting: 'Постапокалиптический мир после зомби-эпидемии. Города разрушены, выжившие объединяются в группы. Ты — один из немногих, кто пережил первые дни хаоса. Теперь каждый день — борьба за ресурсы, защита от зомби и поиск безопасного убежища. Но даже в аду можно найти любовь и надежду.',
    description: 'Выживай среди зомби, защищай группу и найди любовь в конце света.',
    icon: 'Skull',
    themes: ['Хоррор', 'Выживание', 'Зомби', 'Романтика'],
    rating: '18+',
    aiInstructions: `Стиль: Мрачное выживание с акцентом на человечность и романтику в безнадёжности.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Зомби-апокалипсис: города разрушены, ресурсы ограничены, зомби везде
- Игрок — выживший, развивает навыки (стрельба, медицина, крафт)
- Группа выживших: дружба, романтика, конфликты
- Моральные выборы: спасти чужака или сохранить ресурсы?

ПЕРСОНАЖИ:
- Рик/Рейчел (лидер группы, суровый, но заботливый, романтический интерес)
- Майк (механик, оптимист, друг)
- Лара (медик, добрая, моральный компас)
- Трэвис (бывший военный, параноик, конфликтный)
- Неизвестный выживший (присоединяется позже, загадка)

МЕХАНИКИ:
- Поиск ресурсов (еда, вода, оружие, лекарства)
- Защита убежища от зомби и мародёров
- Романтические моменты: тихие вечера у костра, защита друг друга
- Выбор: жертвовать собой или другими?
- Финал: найти безопасное место или принять новый мир

АТМОСФЕРА: Мрачная, напряжённая, но с проблесками человечности. Акцент на связях между людьми.`
  },
  {
    id: 'time-travel-romance',
    title: 'Сквозь время',
    genre: 'Романтика, Фантастика',
    setting: 'Ты — учёный, случайно активировавший машину времени. Каждый прыжок переносит тебя в новую эпоху: средневековье, викторианская Англия, будущее. В каждой эпохе ты встречаешь одного и того же человека — твою родственную душу. Но время жестоко, и вы всегда разлучаетесь. Сможешь ли ты найти способ быть вместе навсегда?',
    description: 'Путешествуй во времени, встречай свою любовь в разных эпохах и измени судьбу.',
    icon: 'Clock',
    themes: ['Романтика', 'Фантастика', 'Путешествия во времени', 'Драма'],
    rating: '16+',
    aiInstructions: `Стиль: Романтическая фантастика с элементами драмы и ностальгии.

КЛЮЧЕВЫЕ ПРАВИЛА:
- Путешествия во времени: средневековье, викторианская эпоха, 1920-е, 1980-е, будущее
- Игрок встречает одного и того же человека в разных воплощениях (рыцарь, художник, солдат, учёный)
- Цель: найти способ остановить цикл разлук
- Романтика центральна, развивается через узнавание друг друга

ПЕРСОНАЖИ:
- Возлюбленный/возлюбленная (в каждой эпохе новое имя, но та же душа: Артур, Элиас, Джеймс, Алекс)
- Профессор Грин (создатель машины времени, наставник)
- Тень (загадочная фигура, преследующая игрока сквозь время)

МЕХАНИКИ:
- Адаптация к эпохам (язык, одежда, обычаи)
- Романтические сцены в разных эпохах (балы, войны, научные открытия)
- Поиск подсказок о том, как остановить цикл
- Выбор: остаться в одной эпохе или продолжить поиски?

АТМОСФЕРА: Ностальгическая, романтичная, с ощущением судьбы. Акцент на вечной любви.`
  }
];

export const TemplateLibrary = () => {
  const [selectedTemplate, setSelectedTemplate] = useState<GameTemplate | null>(null);
  const [isStarting, setIsStarting] = useState(false);
  const { createGame } = useRpgGames();
  const { user } = useAuth();
  const { toast } = useToast();
  const navigate = useNavigate();

  const handleStartTemplate = async (template: GameTemplate) => {
    if (!user) {
      toast({
        title: 'Требуется авторизация',
        description: 'Войдите, чтобы начать игру',
        variant: 'destructive'
      });
      return;
    }

    setIsStarting(true);

    try {
      const gameSettings = {
        role: 'hero',
        narrativeMode: 'first',
        playerCount: 1,
        genre: template.genre,
        rating: template.rating,
        aiModel: 'deepseek',
        aiInstructions: template.aiInstructions,
        initialCharacters: []
      };

      const newGame = await createGame({
        title: template.title,
        genre: template.genre,
        setting: template.setting,
        difficulty: 'normal',
        story_context: JSON.stringify(gameSettings)
      });

      if (newGame) {
        toast({
          title: 'Поехали! 🚀',
          description: `Начинаем "${template.title}"`
        });
        navigate('/play-game', { state: { gameId: newGame.id } });
      } else {
        toast({
          title: 'Ошибка',
          description: 'Не удалось создать игру',
          variant: 'destructive'
        });
      }
    } catch (error) {
      toast({
        title: 'Ошибка',
        description: 'Не удалось создать игру',
        variant: 'destructive'
      });
    } finally {
      setIsStarting(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="text-center space-y-2">
        <h2 className="text-3xl font-bold text-white">Библиотека шаблонов</h2>
        <p className="text-purple-200/80">Выберите готовую историю и начните играть</p>
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {gameTemplates.map((template) => (
          <div
            key={template.id}
            className="group relative p-6 rounded-xl border border-purple-500/30 bg-gradient-to-br from-purple-900/40 via-pink-900/30 to-purple-900/40 backdrop-blur-sm transition-all duration-300 hover:border-purple-400/60 hover:shadow-lg hover:shadow-purple-500/20 cursor-pointer"
            onClick={() => setSelectedTemplate(selectedTemplate?.id === template.id ? null : template)}
          >
            <div className="absolute inset-0 bg-gradient-to-r from-purple-600/0 via-pink-600/0 to-purple-600/0 group-hover:from-purple-600/10 group-hover:via-pink-600/10 group-hover:to-purple-600/10 rounded-xl transition-all duration-300" />
            
            <div className="relative space-y-4">
              <div className="flex items-start justify-between">
                <div className="p-3 rounded-lg bg-purple-500/20 group-hover:bg-purple-500/40 transition-all duration-300">
                  <Icon name={template.icon} size={32} className="text-purple-300" />
                </div>
                <div className="flex gap-1">
                  {template.themes.slice(0, 2).map((theme) => (
                    <span key={theme} className="text-xs px-2 py-1 rounded-full bg-pink-500/20 text-pink-200">
                      {theme}
                    </span>
                  ))}
                </div>
              </div>

              <div>
                <h3 className="text-xl font-bold text-white mb-1">{template.title}</h3>
                <p className="text-sm text-purple-300">{template.genre}</p>
              </div>

              <p className="text-sm text-purple-200/80 line-clamp-3">
                {template.description}
              </p>

              {selectedTemplate?.id === template.id && (
                <div className="space-y-4 pt-4 border-t border-purple-500/30 animate-fade-in">
                  <p className="text-sm text-purple-200/90 max-h-48 overflow-y-auto">
                    {template.setting}
                  </p>
                  
                  <div className="flex gap-2 flex-wrap">
                    {template.themes.map((theme) => (
                      <span key={theme} className="text-xs px-2 py-1 rounded-full bg-purple-500/20 text-purple-200">
                        {theme}
                      </span>
                    ))}
                  </div>

                  <Button
                    onClick={(e) => {
                      e.stopPropagation();
                      handleStartTemplate(template);
                    }}
                    disabled={isStarting}
                    className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white"
                  >
                    {isStarting ? (
                      <>
                        <Icon name="Loader2" className="mr-2 animate-spin" size={18} />
                        Создаём...
                      </>
                    ) : (
                      <>
                        <Icon name="Play" className="mr-2" size={18} />
                        Начать игру
                      </>
                    )}
                  </Button>
                </div>
              )}

              {selectedTemplate?.id !== template.id && (
                <Button
                  variant="outline"
                  className="w-full border-purple-500/30 text-purple-200 hover:bg-purple-500/20"
                >
                  Подробнее
                </Button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};
